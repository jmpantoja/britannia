{% extends get_global_template('layout') %}

{% block content %}

    <div id="calendar"></div>
    <script>
        $(function () {

            var hash = new URI().fragment();
            var date = moment(hash, 'Y-MM-DD', true);

            var current = null;
            if (date.isValid()) {
                current = date.format('Y-MM-DD')
            }
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: ['interaction', 'dayGrid', 'resourceTimeGrid'],
                selectable: true,
                locale: 'es',
                firstDay: 1,
                nowIndicator: false,
                now: current,
                header: {
                    rigt: 'prev,next today',
                    left: 'title',
                    //  right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '{{ path(calendar_endpoint) }}',
                eventRender: function (info) {
                    var data = info.event.extendedProps;
                    var date = info.event.start;
                    var end = info.event.end;

                    while (date < end) {
                        const options = {year: 'numeric', month: 'numeric', day: 'numeric'};
                        var formatted = moment(date).format('YYYY-MM-DD');
                        var td = $('[data-date="' + formatted + '"]');

                        date.setDate(date.getDate() + 1)

                        td.removeClass('holiday')
                        if (data.holiday) {
                            td.addClass('holiday')
                        }
                    }

                },
                select: function (info) {
                    var start = moment(info.start).format('YYYY-MM-DD');
                    var end = moment(info.end).format('YYYY-MM-DD');

                    $('input[name="holiday"]').bootstrapToggle('off')
                    $('input[name="start"]').val(start)
                    $('input[name="end"]').val(end)

                    $('.modal').modal({
                        keyboard: false,
                    })
                }
            });

            calendar.render();
            $('.fc-prev-button span').click(function () {
                var date = calendar.getDate();
                var hash = moment(date).subtract(1, 'months').format('Y-MM-DD');
                window.location.hash = hash;

            });

            $('.fc-next-button span').click(function () {
                var date = calendar.getDate();
                var hash = moment(date).add(1, 'months').format('Y-MM-DD');
                window.location.hash = hash;
            });

            $('.fc-today-button').click(function () {
                var today = moment().format('Y-MM-DD');
                window.location.hash = today;
                calendar.goToDate(today);
                return false;
            });



            $('.modal button.submit').on('click', function () {

                var holiday = $('input[name="holiday"]').prop('checked');

                var start = $('.modal input[name="start"]').val()
                var end = $('.modal input[name="end"]').val()

                $.ajax({
                    type: 'POST',
                    url: '{{ path(change_status_action) }}',
                    data: {
                        'start': start,
                        'end': end,
                        'holiday': holiday
                    },
                    dataType: "json",
                    success: function (data) {
                        calendar.refetchEvents()
                    }
                });
            })
        });


    </script>


    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-md ">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Modal title</h4>
                </div>
                <div class="modal-body">

                    <input name="holiday" type="checkbox" data-toggle="toggle"
                           value="yes"
                           data-width="150px"
                           data-on="Festivo"
                           data-off="Laborable"
                           data-onstyle="danger"
                           data-offstyle="success"
                    />
                    <hr/>
                    <input name="start" type="hidden"/>
                    <input name="end" type="hidden"/>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary submit" data-dismiss="modal">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
